USE master 
if exists (select * from sysdatabases where name='QLThucAnNhanh')
drop database QLThucAnNhanh		
CREATE DATABASE QLThucAnNhanh
GO
USE QLThucAnNhanh
CREATE TABLE KHACHHANG
	(MAKHACHHANG INT IDENTITY(1,1) NOT NULL,
	TENKHACHHANG NVARCHAR(MAX)NOT NULL,
	NGAYSINH DATETIME,
	DIACHI NVARCHAR(MAX),
	SDT INT UNIQUE not null,
	EMAIL VARCHAR(MAX) not null,
	PASSWORD VARCHAR(MAX),
	LOAI NVARCHAR(30),
	CONSTRAINT PK_KHACHHANG PRIMARY KEY(MAKHACHHANG)
	)
CREATE TABLE NHANVIEN
	(MANHANVIEN INT IDENTITY(1,1) NOT NULL,
	TENNV NVARCHAR(MAX)NOT NULL,
	SDT INT,
	EMAIL VARCHAR(MAX) not null,
	PASSWORD VARCHAR(MAX) not null,
	CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANHANVIEN)
	)
CREATE TABLE KHUYENMAI
	(MAKHUYENMAI varchar(30) NOT NULL,
	GIAMGIA FLOAT,
	NGAYBATDAU DATETIME,
	NGAYKETTHUC DATETIME,
	CONSTRAINT PK_KHUYENMAI PRIMARY KEY (MAKHUYENMAI)
	)
CREATE TABLE TINHTRANGDON
	(MATINHTRANG INT IDENTITY(1,1) NOT NULL,
	TINHTRANG NVARCHAR(30),
	CONSTRAINT PK_TINHTRANGDON PRIMARY KEY (MATINHTRANG)
	)
CREATE TABLE DONVITINH
(
	MADONVITINH INT IDENTITY(1,1) NOT NULL,
	TENDONVITINH NVARCHAR(20),
	CONSTRAINT PK_DONVITINH PRIMARY KEY (MADONVITINH)
	)
CREATE TABLE LOAI
(
	MALOAI VARCHAR(10) NOT NULL,
	TENLOAI NVARCHAR(20) NOT NULL,
	CONSTRAINT PK_LOAI PRIMARY KEY (MALOAI),
	
	)
CREATE TABLE MONAN
	(
	MAMONAN varchar(10) NOT NULL ,
	TENMONAN NVARCHAR(MAX)NOT NULL,
	HINHANH TEXT NULL,
	MADONVITINH INT NOT NULL,
	GIABAN FLOAT NOT NULL,
	MOTA NVARCHAR(MAX),
	MALOAI VARCHAR(10) NOT NULL,
	SOLUONG INT NOT NULL,
	STATUS INT NULL DEFAULT '1',
	CONSTRAINT pk_MONAN PRIMARY KEY (MAMONAN),
	CONSTRAINT FK_MONAN_DONVITINH FOREIGN KEY (MADONVITINH) REFERENCES DONVITINH(MADONVITINH),
	CONSTRAINT FK_MONAN_LOAI FOREIGN KEY (MALOAI) REFERENCES LOAI(MALOAI)
	)

CREATE TABLE DIACHIGH
(	MADIACHI INT IDENTITY(1,1) NOT NULL,
	MAKHACHHANG INT , 
	HOTEN NVARCHAR(MAX) NOT NULL,
	SDT INT NOT NULL,
	SONHA NVARCHAR(100) NOT NULL,
	PHUONG NVARCHAR(30) NOT NULL,
	QUAN NVARCHAR(30) NOT NULL,
CONSTRAINT PK_DIACHIGH PRIMARY KEY (MADIACHI),
CONSTRAINT FK_DIACHIGH_KHACHHANG FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG)
)

CREATE TABLE DATHANG
(
	MADATHANG INT IDENTITY(1,1) NOT NULL,
	NGAY DATETIME NOT NULL,
	MADIACHI INT NOT NULL ,
	TONGTIEN FLOAT,
	GHICHU NVARCHAR(MAX) NULL,
	TRANGTHAI INT NOT NULL DEFAULT '0',
	CONSTRAINT PK_DATHANG PRIMARY KEY (MADATHANG),
	CONSTRAINT FK_DATHANG_DIACHIGH FOREIGN KEY (MADIACHI) REFERENCES DIACHIGH(MADIACHI)
)
	
CREATE TABLE CT_MONAN_DATHANG
	(	
	MADATHANG INT not null,
	MAMONAN varchar(10) NOT NULL,
	SOLUONG INT,
	GIABAN FLOAT,
	CONSTRAINT PK_MACTMONANDATHANG PRIMARY KEY (MADATHANG,MAMONAN),
	CONSTRAINT FK_CT_DATHANG FOREIGN KEY (MADATHANG) REFERENCES DATHANG(MADATHANG),
	CONSTRAINT FK_CT_MONAN FOREIGN KEY (MAMONAN) REFERENCES MONAN(MAMONAN)
	)


CREATE TABLE HOADON
	(MAHOADON INT IDENTITY(1,1) NOT NULL,
	--MAKHUYENMAI varchar(30) NOT NULL,
	MANHANVIEN INT NULL,
	MADATHANG INT not null,
	TONGTIEN FLOAT NOT NULL,
	NGAYGIO DATETIME,
	TONGTHUE FLOAT,
	GHICHU NVARCHAR(MAX),
	CONSTRAINT PK_HOADON PRIMARY KEY (MAHOADON),
	CONSTRAINT FK_HOADON_DATHANG FOREIGN KEY (MADATHANG) REFERENCES DATHANG(MADATHANG),
	CONSTRAINT FK_HOADON_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN),
	--CONSTRAINT FK_HOADON_CTHOADON FOREIGN KEY (MADATHANG,MAMONAN) REFERENCES CTHOADON(MADATHANG,MAMONAN),
	--CONSTRAINT FK_HOADON_KHUYENMAI FOREIGN KEY (MAKHUYENMAI) REFERENCES KHUYENMAI(MAKHUYENMAI),
	)
CREATE TABLE CTHOADON
	(
	MAHOADON INT not null,
	MADATHANG INT not null,
	MAMONAN varchar(10) NOT NULL,
	SOLUONG INT,
	GHICHU NVARCHAR(MAX),
	CONSTRAINT PK_CTHOADON PRIMARY KEY (MAHOADON,MADATHANG,MAMONAN),
	CONSTRAINT FK_CTHOADON_HOADON FOREIGN KEY (MAHOADON) REFERENCES HOADON(MAHOADON),
	CONSTRAINT FK_CTDATHANG_CTHOADON FOREIGN KEY (MADATHANG,MAMONAN) REFERENCES CT_MONAN_DATHANG(MADATHANG,MAMONAN)
	)
CREATE TABLE THONGKEBAOCAO
	(MATHONGKEBAOCAO INT IDENTITY(1,1) NOT NULL,
	THANG DATETIME NOT NULL,
	GHICHU NVARCHAR(MAX),
	CONSTRAINT PK_THONGKEBAOCAO PRIMARY KEY (MATHONGKEBAOCAO),
	)
CREATE TABLE FEEDBACK
	(MAFEEDBACK INT IDENTITY(1,1) NOT NULL,
	TENKH NVARCHAR(20) NULL,
	SDT INT NOT NULL,
	NOIDUNG NVARCHAR(300) NOT NULL,
	CONSTRAINT PK_FEEDBACK PRIMARY KEY (MAFEEDBACK),
	
	)
CREATE TABLE ADMIN
(ID INT IDENTITY (1,1)NOT NULL,
Email nvarchar (MAX) null,
Pass varchar (MAX) null,
CONSTRAINT PK_ACCOUNT PRIMARY KEY(ID),
)
insert into LOAI
values('CB',N'Combo'),
('GA ',N'Gà '),
('NUOC',N'Thức uống')
insert into DONVITINH
values(N'Dĩa'),
(N'Ly'),
(N'Phần'),
(N'Cái')




CREATE FUNCTION AUTO_IDmonan()
RETURNS VARCHAR(30)
AS
BEGIN
	DECLARE @ID VARCHAR(30)
	IF (SELECT COUNT(MAMONAN) FROM MONAN) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MAMONAN, 3)) FROM MONAN
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'MB00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'MB0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END
